<!DOCTYPE html>
<html lang="cn">

<head>
    <meta charset="UTF-8">
    <title>WebSocket chart application</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./css/bootstrap.3.3.7.min.css">
    <link rel="stylesheet" href="./css/tether.css"/>
    <link rel="stylesheet" href="./css/sweetalert.css"/>
    <link rel="stylesheet" href="./css/index.css" charset="utf-8"/>

    <script src="./js/jquery.min.2.2.4.js" ></script>
    <script src="./js/bootstrap.3.3.6.min.js"></script>
    <script src="./js/jquery.cookie.js"></script>
    <script src="./js/tether.js"></script>
    <script src="./js/sweetalert.min.js"></script>

    <script>

        function doNotice(name,notice) {
            var button = document.getElementById('btn');
//            var text = document.getElementById('text');

            if (window.Notification) {
                var popNotice = function() {
                    if (Notification.permission == "granted") {
                        var notification = new Notification(name, {
                            body: notice,
                            icon: 'http://59.110.212.84/pic/zhao.jpg'
                        });

                        notification.onclick = function() {
//                            text.innerHTML = '消息已于' + new Date().toTimeString().split(' ')[0]+"送达";
                            notification.close();
                        };
                    }
                };

                button.onclick = function() {
                    if (Notification.permission == "granted") {
                        popNotice();
                    } else if (Notification.permission != "denied") {
                        Notification.requestPermission(function (permission) {
                            popNotice();
                        });
                    }
                };
                $("#btn").trigger("click");
            } else {
                alert('浏览器不支持Notification');
            }
        }



        <!--消息通知-->
        function noticemsg(msg) {
            console.log(msg);
            swal("消息来了",""+msg+"");

        }

//        添加用户到cookie的方法
        function addUser() {
            swal({
                title: "请输入用户名！",
                text: "尽量文雅一些",
                type: "input",
                showCancelButton: true,
                closeOnConfirm: false,
                animation: "slide-from-top",
                inputPlaceholder: "人生若只如初见"
            }, function(inputValue) {
                if (inputValue === false) {
                    return false;
                }
                if (inputValue === "") {
                    swal.showInputError("内容不能为空！");
                    return false;
                }
                swal("Nice!", "你输入的是：" + inputValue, "success");
                $.cookie("Uname",inputValue,{ expires: 7, path: '/' });

            })
        }
        
        //从cookie中设置用户名，或没有则，弹出窗体，设置用户名
        $(function () {
//            初始化div的 滚轴
            var talkArea =document.getElementById('talkArea');
//            talkArea.scrollTop=0;
            talkArea.scrollTop=talkArea.scrollHeight;


//            初始化 判断
            var name = $.cookie("Uname");
            if(name == null){
                addUser();
            }
        });


//        var url='ws://192.168.12.158:8084/ws/';
        //        192.168.12.158:8084
        var hostName =window.location.host;

        //        "/zhao/index.html"
        var pathName=window.location.pathname;

        console.log(hostName);
        console.log(pathName);

        //通过pathName解析到/zhao/即可
        var position = pathName.indexOf("/",1);
        var pathName = pathName.substring(0,position+1);

        console.log(pathName);
        var path=hostName+pathName;


        var wsPath="ws://"+path+'wsChat';

        var ws= new WebSocket(wsPath);

        function appendLog(type,nickname, message,client_count) {
            var messages = document.getElementById('messages');
            var messageElem = document.createElement("li");
            var preface_label;
            if(type==='notification') {
                preface_label = "<span class=\"label label-info\">*</span>";
            } else if(type==='nick_update') {
                preface_label = "<span class=\"label label-warning\">*</span>";
            } else {
                preface_label = "<span class=\"label label-success\">" + nickname + "</span>";
            }
            var message_text = "<h2>" + preface_label + "  " + message + "</h2>";
            messageElem.innerHTML = message_text;
            messages.appendChild(messageElem);
            var count_people = document.getElementById("count_people");
            count_people.innerHTML = client_count;
            /*判断当前窗口是否活动
            console.log(document.visibilityState);
            console.log("----");
            console.log(document.hidden);
            */
            if(document.visibilityState =="visible"){

            }else {
                doNotice(nickname,message);
            }


        }
        ws.onopen = function (e) {
       /*     var name = $.cookie("Uname");
            ws.send(name);*/
        };
        ws.onmessage = function(e){
            var data = JSON.parse(e.data);
            var type=e.type;
            var name = data.nickname;
            var msg = data.msg;
            var clientCount=data.clientcount;

            appendLog(type,name, msg, clientCount);
        };

        function sendMessage(){
            var msg = $('#message').val().trim();
            var name= $.cookie("Uname");
            if(msg.length<1){
                alert("不能发送空内容！");
                return;
            }

            var mm={
                msg:msg,
                from:name,
                to:'zhao',
                nickname:"",
                ua:"",
                msgAt:"",
                pic:"",
                clientcount:""
            };
            var mStr = JSON.stringify(mm);
            ws.send(mStr);

            $('#message').val("");

            $('#message').focus();
        }
    </script>
</head>
<body lang="cn">
<div class="vertical-center">
    <div class="container">
        <div id="btn" ></div>
        <h2>多人在线聊天</h2>
        <hr />
        <p>当前在线人数：<span id="count_people">1</span></p>
        <div><P><span id="onLine"></span></P></div>
        <div id="talkArea" class="talkArea">
            <ul id="messages" class="list-unstyled">

            </ul>
        </div>

        <ul id="one" class="">

        </ul>
        <hr />
        <form role="form" id="chat_form" onsubmit="sendMessage(); return false;">
            <div class="form-group">
                <input class="form-control" type="text" name="message" id="message"
                       placeholder="输入聊天内容" value="" autofocus/>
            </div>
            <button type="button" id="send" class="btn btn-primary"
                    onclick="sendMessage();">发送!</button>
        </form>

    </div>
</div>
</body>
<script>
/*
    var pathName2=window.location.pathname;
    var hostName2 =window.location.host;

    var path2=hostName2+pathName2;
    var online="ws://"+path2+'wsOnline';
    var wsOnline= new WebSocket(online);


    wsOnline.onopen = function (e) {
        var name = $.cookie("Uname");
        wsOnline.send(name);
    };
    function appendOnlie(type,nickname) {
        var Onmessages = document.getElementById('onLine');
        var OnmessageElem = document.createElement("li");
        var preface_label_on;
        if(type==='notification') {
            preface_label_on = "<span class=\"label label-info\">*</span>";
        } else if(type==='nick_update') {
            preface_label_on = "<span class=\"label label-warning\">*</span>";
        } else {
            preface_label_on = "<span class=\"label label-success\">" + nickname + "</span>";
        }
        var message_text_on = "<h2>" + preface_label_on + "</h2>";
        OnmessageElem.innerHTML = message_text_on;
        Onmessages.appendChild(OnmessageElem);
    }
    wsOnline.onmessage = function(e){
        var data = JSON.parse(e.data);
        var type=e.type;
        var name = data.nickname;

        appendOnlie(type,name);
    };

    function sendMessage(){

    }*/
</script>
</html>